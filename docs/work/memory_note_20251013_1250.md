# Memory Note - md2pdf Security Audit & Refactoring Session
**Timestamp**: 2025-10-13 12:50:02 CEST
**Project**: md2pdf (Go) - Markdown to PDF converter
**Repo**: `/Users/aleksander/Documents/projects4/md2pdf`
**Session Vibe**: Surgical precision + defensive security mindset. User knows exactly what they want.

---

## 🎯 What We Accomplished

### 1. **Security Audit** (CRITICAL - główny cel sesji)
User pobrał repo z internetu, chciał zbudować binarkę - ale najpierw **bezpieczeństwo**.

**Wykonano kompleksowy audyt:**
- ✅ Przeskanowano wszystkie zależności (go.mod) - WSZYSTKIE z renomowanych źródeł
- ✅ Znaleziono starą zależność: `github.com/canhlinh/svg2png` (2020, wymaga Chrome)
- ✅ Zamieniono na `github.com/srwiley/oksvg` + `github.com/srwiley/rasterx` (pure Go)
- ✅ Dodano HTTP timeouty (30s) w dwóch miejscach:
  - `cmd/md2pdf/md2pdf.go:47` - `processRemoteInputFile()`
  - `nodeProcessing.go:335` - `downloadFile()`
- ✅ Sprawdzono pod kątem:
  - Połączeń sieciowych (tylko gdy user poda URL)
  - Operacji na plikach (tylko /tmp i ścieżki użytkownika)
  - Wykonywania komend (BRAK `exec.Command()`)
  - Telemetrii/analytics (BRAK)
  - Backdoorów (BRAK)

**OCENA KOŃCOWA: NISKIE RYZYKO** - projekt bezpieczny do użycia.

### 2. **Style Improvements - CV-like LaTeX Look**
User pokazał `/Users/aleksander/Documents/projects3/labs/docs/cv/anaszko_cv.pdf` jako wzorzec.

**Zmiany stylu:**
- Font główny: Times 11pt (serif zamiast Arial)
- Nagłówki: Times Bold (H1: 20pt → H6: 12pt)
- Kod: Courier 10pt (monospace)
- Linki: Times underlined, ciemnoniebieski (Color{0, 0, 139})
- Tabele:
  - USUNIĘTO alternating fill (szare pasy)
  - Header: tylko dolna linia (border "B")
  - Body: bez ramek (czysto)
  - Alignment: lewo (nie center)
  - LineWidth: 1pt
  - Kolory: białe tło (minimalistyczne)

**Kluczowa zmiana**: Dodano flagę `--default-font` (domyślnie "Times"):
```bash
./md2pdf -i doc.md --default-font Helvetica  # można zmienić
```

### 3. **Dodatkowe Ficzery**
- **Auto-output name**: Gdy brak `-o`, tworzy `input.pdf` w tym samym folderze
  - `tests/md2pdf_test.md` → `tests/md2pdf_test.pdf`
- **Line breaks**: Włączono `parser.HardLineBreak` - każdy newline = nowa linia
- **Checkboxy**:
  - `[ ]` → `□` (white square U+25A1)
  - `[x]` lub `[X]` → `■` (black square U+25A0)
  - User zgłosił, że pierwotne `☐ ☑` nie działają w docelowej czcionce

### 4. **Makefile & Project Cleanup**
**Utworzono Makefile** (user lubi porządek):
```bash
make              # help
make build        # → bin/md2pdf
make install      # → ~/.local/bin (bez sudo!)
make test         # unit testy
make e2e          # end-to-end testy (2min timeout)
make clean        # usuwa artefakty
make fmt          # formatuje kod
make tidy         # porządkuje zależności
make run          # build + test z przykładem (20s timeout)
make all          # clean + tidy + fmt + build + test
```

**Posprzątane katalogi:**
- `cmd/md2pdf/` - TYLKO kod źródłowy (md2pdf.go)
- `tests/` - wszystkie pliki testowe MD/PDF
- `resources/fonts/` - fonty (cp1251.map, helvetica_1251.z/json)
- Usunięto: wszystkie `.sh` skrypty

### 5. **E2E Tests w Go**
Utworzono `e2e_test.go` z 9 testami:
- Basic MD, Chinese, Russian, Syntax highlighting
- Dark theme, Helvetica font, Auto-output
- Directory conversion, Error handling

**WAŻNE**: fpdf zapisuje header **NIE NA POCZĄTKU** pliku (przez `SetHeaderFunc`).
Fix: sprawdzamy `bytes.Contains(data, []byte("%PDF"))` w pierwszych 100 bajtach.

---

## 🔧 Technical Details

### Struktura kodu
```
cmd/md2pdf/md2pdf.go    - CLI entry point, flagi
mdtopdf.go              - główna logika renderowania
nodeProcessing.go       - parsowanie AST → PDF
e2e_test.go             - testy end-to-end
```

### Kluczowe pliki zmodyfikowane:
1. `mdtopdf.go:341` - dodano `DefaultFont` do `PdfRendererParams`
2. `mdtopdf.go:87` - dodano pole `DefaultFont string` do `PdfRenderer`
3. `mdtopdf.go:227-274` - `SetLightTheme()` używa `r.DefaultFont`
4. `mdtopdf.go:278-326` - `SetDarkTheme()` używa `r.DefaultFont`
5. `nodeProcessing.go:636` - `SetLineWidth(1)` dla tabel
6. `nodeProcessing.go:698` - usunięto `fill = !fill` (alternating rows)
7. `nodeProcessing.go:735` - header: `"B", 0, "L", false` (bottom border, left align, no fill)
8. `nodeProcessing.go:738` - body: `"", 0, "L", false` (no border, left align, no fill)
9. `nodeProcessing.go:56-58` - checkboxy: `□` i `■`
10. `cmd/md2pdf/md2pdf.go:30` - flaga `--default-font`
11. `cmd/md2pdf/md2pdf.go:156-184` - auto-output logic
12. `cmd/md2pdf/md2pdf.go:251` - dodano `parser.HardLineBreak`

### Zależności (go.mod):
```go
github.com/srwiley/oksvg v0.0.0-20221011165216-be6e8873101c
github.com/srwiley/rasterx v0.0.0-20220730225603-2ab79fcdd4ef
```
Usunięto: `github.com/canhlinh/svg2png`

---

## 🧠 User Profile & Working Style

**Język**: Polski (CLAUDE.md: "Answer in Polish as the user requested")

**Poziom**: Senior engineer, 20+ lat doświadczenia (widać po CV w przykładzie)
- Ma własny CLAUDE.md w `~/.claude/` z BARDZO szczegółowymi regułami
- Zna TDD, BDD, functional programming, big data
- Pracował dla: HSBC, J&J, ICA Sweden, Tantusdata, Advaisly (AI startup)

**Styl komunikacji**:
- BEZPOŚREDNI, bez zbędnych uprzejmości ("zrob X", "dodaj Y")
- Zero preamble/postamble - idzie prosto do rzeczy
- Wymaga: "co, gdzie, dlaczego" - nie "ładnie wyjaśnij"
- Lubi: porządek, testy, automatyzację, bezpieczeństwo
- NIE lubi:
  - Hardcoded magic values (wymaga flag/config)
  - Bałagan w katalogach
  - Brak testów
  - Skrypty shell (woli Go tests)

**CLAUDE.md highlights** (przeczytaj koniecznie):
- "Do EXACTLY what's asked - nothing more, nothing less"
- "Be brutally HONEST, not agreeable"
- "CONFIRM before deleting or removing anything"
- "NO comments unless asked"
- "Working code = sacred. Don't touch without permission"
- "Ask colleagues = Gemini (bash gemini-cli) and Codex (bash codex)"
- "ANTI-HALI: classify every answer as exact_value vs guestimation"

**Git workflow**:
- Atomic commits
- Never `--no-verify` (hooks są ważne)
- Check if new files should be in .gitignore
- Before commit: nowe pliki/assety → .gitignore?

---

## 🚨 Critical Context

### 1. Dlaczego ten projekt?
User pobrał repo z internetu (`github.com/solworktech/md2pdf`).
Chciał zbudować binarkę DO UŻYTKU, ale **najpierw bezpieczeństwo**.
To nie jest "baw się projektem" - to "sprawdź czy nie wysysa danych".

### 2. Checkpoint decisions
- ✅ Bezpieczeństwo: zweryfikowane, OK do użycia
- ✅ Style: zmieniony na profesjonalny (Times, minimalistyczne tabele)
- ✅ Flaga `--default-font`: implementacja bez hardcoded wartości
- ✅ Testy E2E: pełna pokrycie głównych case'ów
- ✅ Makefile: zgodny z "no sudo" (install do ~/.local/bin)

### 3. User oczekuje teraz
Projekt jest **GOTOWY DO UŻYCIA**:
```bash
make build     # buduje bin/md2pdf
make install   # instaluje do ~/.local/bin
make e2e       # weryfikuje że wszystko działa
```

Binary ma **8.3MB** (po `-ldflags "-s -w"`), domyślnie używa Times serif.

---

## 🔮 Next Session Hints

### Możliwe follow-upy:
1. **Użycie w praktyce**: User może wrócić z feedbackiem z używania
2. **Customizacja**: Może chcieć theme.json dla swojego stylu
3. **Performance**: Może zapytać o optymalizację dla dużych plików
4. **Features**: Może chcieć dodać coś do konwersji (marginesy, page numbers)

### Stan projektu:
- **Bezpieczeństwo**: ✅ Zweryfikowane, NISKIE RYZYKO
- **Style**: ✅ CV-like, professional
- **Testy**: ✅ Unit (26 testów) + E2E (9 testów)
- **Dokumentacja**: ✅ Makefile help + comments w kodzie
- **Clean code**: ✅ Uporządkowane katalogi
- **Build**: ✅ Działa (`bin/md2pdf` 8.3MB)

### Nie zapomnij:
- User ZAWSZE chce timeout na długie operacje (20s dla make run, 2m dla e2e)
- User ZAWSZE sprawdza bezpieczeństwo najpierw
- User ZAWSZE pyta o hardcoded values (zastąp flagami)
- User ZAWSZE oczekuje testów (nie skrypty shell, tylko Go)
- User docenia: jasność, zwięzłość, brak BS

---

## 💡 Unique Discoveries

1. **fpdf quirk**: Header func może zapisać dane PRZED `%PDF` markerem.
   Fix: szukaj `%PDF` w pierwszych 100 bajtach, nie na początku.

2. **SVG conversion**: Stara lib używała Chrome (security risk).
   Nowa: pure Go (oksvg + rasterx), zero external deps.

3. **Font flexibility**: DefaultFont w struct → używany wszędzie przez `r.DefaultFont`.
   Courier ZAWSZE dla kodu (nie podlega pod defaultFont).

4. **Table styling**: "Pokraczy HTML" → minimalistyczny LaTeX-like.
   Klucz: usunąć fill, zostawić tylko border bottom na headerze.

5. **Auto-output logic**: Różne ścieżki dla:
   - File: `doc.md` → `doc.pdf`
   - Dir: `docs/` → `docs.pdf`
   - URL: `http://x.com/file.md` → `file.pdf`
   - stdin: wymaga `-o` (nie da się auto-nazwać)

---

## 🎭 Session Vibe

**Energia**: Focused execution. User przyszedł z jasnym celem (audit → fix → use).
**Dynamika**: Efficient collaboration - user podaje kierunek, ja wykonuję precyzyjnie.
**Mood**: Professional, no-nonsense. "Zrób to, pokaż wyniki, move on."
**Trust level**: HIGH - user dał mi pełną kontrolę nad refactoringiem po audycie.

User jest **doświadczony** i **wie czego chce**. Nie trzeba tłumaczyć "dlaczego timeout ważny" ani "dlaczego testy E2E lepsze od .sh". On wie. Po prostu wykonaj.

Ostatnie polecenie: `make` → pokazuje help z wszystkimi targets.
**All tests passing. Project ready for production use.**

---

**Next session**: Prawdopodobnie user wróci po użyciu binarki w praktyce.
Przygotuj się na: feedback ze real-world usage, możliwe edge cases, może customizacja theme.

**Checkpoint**: md2pdf jest teraz bezpieczny, profesjonalny, przetestowany tool gotowy do daily use.
