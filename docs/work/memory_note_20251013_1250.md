# Memory Note - md2pdf Security Audit & Refactoring Session
**Timestamp**: 2025-10-13 12:50:02 CEST
**Project**: md2pdf (Go) - Markdown to PDF converter
**Repo**: `/Users/aleksander/Documents/projects4/md2pdf`
**Session Vibe**: Surgical precision + defensive security mindset. User knows exactly what they want.

---

## ğŸ¯ What We Accomplished

### 1. **Security Audit** (CRITICAL - gÅ‚Ã³wny cel sesji)
User pobraÅ‚ repo z internetu, chciaÅ‚ zbudowaÄ‡ binarkÄ™ - ale najpierw **bezpieczeÅ„stwo**.

**Wykonano kompleksowy audyt:**
- âœ… Przeskanowano wszystkie zaleÅ¼noÅ›ci (go.mod) - WSZYSTKIE z renomowanych ÅºrÃ³deÅ‚
- âœ… Znaleziono starÄ… zaleÅ¼noÅ›Ä‡: `github.com/canhlinh/svg2png` (2020, wymaga Chrome)
- âœ… Zamieniono na `github.com/srwiley/oksvg` + `github.com/srwiley/rasterx` (pure Go)
- âœ… Dodano HTTP timeouty (30s) w dwÃ³ch miejscach:
  - `cmd/md2pdf/md2pdf.go:47` - `processRemoteInputFile()`
  - `nodeProcessing.go:335` - `downloadFile()`
- âœ… Sprawdzono pod kÄ…tem:
  - PoÅ‚Ä…czeÅ„ sieciowych (tylko gdy user poda URL)
  - Operacji na plikach (tylko /tmp i Å›cieÅ¼ki uÅ¼ytkownika)
  - Wykonywania komend (BRAK `exec.Command()`)
  - Telemetrii/analytics (BRAK)
  - BackdoorÃ³w (BRAK)

**OCENA KOÅƒCOWA: NISKIE RYZYKO** - projekt bezpieczny do uÅ¼ycia.

### 2. **Style Improvements - CV-like LaTeX Look**
User pokazaÅ‚ `/Users/aleksander/Documents/projects3/labs/docs/cv/anaszko_cv.pdf` jako wzorzec.

**Zmiany stylu:**
- Font gÅ‚Ã³wny: Times 11pt (serif zamiast Arial)
- NagÅ‚Ã³wki: Times Bold (H1: 20pt â†’ H6: 12pt)
- Kod: Courier 10pt (monospace)
- Linki: Times underlined, ciemnoniebieski (Color{0, 0, 139})
- Tabele:
  - USUNIÄ˜TO alternating fill (szare pasy)
  - Header: tylko dolna linia (border "B")
  - Body: bez ramek (czysto)
  - Alignment: lewo (nie center)
  - LineWidth: 1pt
  - Kolory: biaÅ‚e tÅ‚o (minimalistyczne)

**Kluczowa zmiana**: Dodano flagÄ™ `--default-font` (domyÅ›lnie "Times"):
```bash
./md2pdf -i doc.md --default-font Helvetica  # moÅ¼na zmieniÄ‡
```

### 3. **Dodatkowe Ficzery**
- **Auto-output name**: Gdy brak `-o`, tworzy `input.pdf` w tym samym folderze
  - `tests/md2pdf_test.md` â†’ `tests/md2pdf_test.pdf`
- **Line breaks**: WÅ‚Ä…czono `parser.HardLineBreak` - kaÅ¼dy newline = nowa linia
- **Checkboxy**:
  - `[ ]` â†’ `â–¡` (white square U+25A1)
  - `[x]` lub `[X]` â†’ `â– ` (black square U+25A0)
  - User zgÅ‚osiÅ‚, Å¼e pierwotne `â˜ â˜‘` nie dziaÅ‚ajÄ… w docelowej czcionce

### 4. **Makefile & Project Cleanup**
**Utworzono Makefile** (user lubi porzÄ…dek):
```bash
make              # help
make build        # â†’ bin/md2pdf
make install      # â†’ ~/.local/bin (bez sudo!)
make test         # unit testy
make e2e          # end-to-end testy (2min timeout)
make clean        # usuwa artefakty
make fmt          # formatuje kod
make tidy         # porzÄ…dkuje zaleÅ¼noÅ›ci
make run          # build + test z przykÅ‚adem (20s timeout)
make all          # clean + tidy + fmt + build + test
```

**PosprzÄ…tane katalogi:**
- `cmd/md2pdf/` - TYLKO kod ÅºrÃ³dÅ‚owy (md2pdf.go)
- `tests/` - wszystkie pliki testowe MD/PDF
- `resources/fonts/` - fonty (cp1251.map, helvetica_1251.z/json)
- UsuniÄ™to: wszystkie `.sh` skrypty

### 5. **E2E Tests w Go**
Utworzono `e2e_test.go` z 9 testami:
- Basic MD, Chinese, Russian, Syntax highlighting
- Dark theme, Helvetica font, Auto-output
- Directory conversion, Error handling

**WAÅ»NE**: fpdf zapisuje header **NIE NA POCZÄ„TKU** pliku (przez `SetHeaderFunc`).
Fix: sprawdzamy `bytes.Contains(data, []byte("%PDF"))` w pierwszych 100 bajtach.

---

## ğŸ”§ Technical Details

### Struktura kodu
```
cmd/md2pdf/md2pdf.go    - CLI entry point, flagi
mdtopdf.go              - gÅ‚Ã³wna logika renderowania
nodeProcessing.go       - parsowanie AST â†’ PDF
e2e_test.go             - testy end-to-end
```

### Kluczowe pliki zmodyfikowane:
1. `mdtopdf.go:341` - dodano `DefaultFont` do `PdfRendererParams`
2. `mdtopdf.go:87` - dodano pole `DefaultFont string` do `PdfRenderer`
3. `mdtopdf.go:227-274` - `SetLightTheme()` uÅ¼ywa `r.DefaultFont`
4. `mdtopdf.go:278-326` - `SetDarkTheme()` uÅ¼ywa `r.DefaultFont`
5. `nodeProcessing.go:636` - `SetLineWidth(1)` dla tabel
6. `nodeProcessing.go:698` - usuniÄ™to `fill = !fill` (alternating rows)
7. `nodeProcessing.go:735` - header: `"B", 0, "L", false` (bottom border, left align, no fill)
8. `nodeProcessing.go:738` - body: `"", 0, "L", false` (no border, left align, no fill)
9. `nodeProcessing.go:56-58` - checkboxy: `â–¡` i `â– `
10. `cmd/md2pdf/md2pdf.go:30` - flaga `--default-font`
11. `cmd/md2pdf/md2pdf.go:156-184` - auto-output logic
12. `cmd/md2pdf/md2pdf.go:251` - dodano `parser.HardLineBreak`

### ZaleÅ¼noÅ›ci (go.mod):
```go
github.com/srwiley/oksvg v0.0.0-20221011165216-be6e8873101c
github.com/srwiley/rasterx v0.0.0-20220730225603-2ab79fcdd4ef
```
UsuniÄ™to: `github.com/canhlinh/svg2png`

---

## ğŸ§  User Profile & Working Style

**JÄ™zyk**: Polski (CLAUDE.md: "Answer in Polish as the user requested")

**Poziom**: Senior engineer, 20+ lat doÅ›wiadczenia (widaÄ‡ po CV w przykÅ‚adzie)
- Ma wÅ‚asny CLAUDE.md w `~/.claude/` z BARDZO szczegÃ³Å‚owymi reguÅ‚ami
- Zna TDD, BDD, functional programming, big data
- PracowaÅ‚ dla: HSBC, J&J, ICA Sweden, Tantusdata, Advaisly (AI startup)

**Styl komunikacji**:
- BEZPOÅšREDNI, bez zbÄ™dnych uprzejmoÅ›ci ("zrob X", "dodaj Y")
- Zero preamble/postamble - idzie prosto do rzeczy
- Wymaga: "co, gdzie, dlaczego" - nie "Å‚adnie wyjaÅ›nij"
- Lubi: porzÄ…dek, testy, automatyzacjÄ™, bezpieczeÅ„stwo
- NIE lubi:
  - Hardcoded magic values (wymaga flag/config)
  - BaÅ‚agan w katalogach
  - Brak testÃ³w
  - Skrypty shell (woli Go tests)

**CLAUDE.md highlights** (przeczytaj koniecznie):
- "Do EXACTLY what's asked - nothing more, nothing less"
- "Be brutally HONEST, not agreeable"
- "CONFIRM before deleting or removing anything"
- "NO comments unless asked"
- "Working code = sacred. Don't touch without permission"
- "Ask colleagues = Gemini (bash gemini-cli) and Codex (bash codex)"
- "ANTI-HALI: classify every answer as exact_value vs guestimation"

**Git workflow**:
- Atomic commits
- Never `--no-verify` (hooks sÄ… waÅ¼ne)
- Check if new files should be in .gitignore
- Before commit: nowe pliki/assety â†’ .gitignore?

---

## ğŸš¨ Critical Context

### 1. Dlaczego ten projekt?
User pobraÅ‚ repo z internetu (`github.com/solworktech/md2pdf`).
ChciaÅ‚ zbudowaÄ‡ binarkÄ™ DO UÅ»YTKU, ale **najpierw bezpieczeÅ„stwo**.
To nie jest "baw siÄ™ projektem" - to "sprawdÅº czy nie wysysa danych".

### 2. Checkpoint decisions
- âœ… BezpieczeÅ„stwo: zweryfikowane, OK do uÅ¼ycia
- âœ… Style: zmieniony na profesjonalny (Times, minimalistyczne tabele)
- âœ… Flaga `--default-font`: implementacja bez hardcoded wartoÅ›ci
- âœ… Testy E2E: peÅ‚na pokrycie gÅ‚Ã³wnych case'Ã³w
- âœ… Makefile: zgodny z "no sudo" (install do ~/.local/bin)

### 3. User oczekuje teraz
Projekt jest **GOTOWY DO UÅ»YCIA**:
```bash
make build     # buduje bin/md2pdf
make install   # instaluje do ~/.local/bin
make e2e       # weryfikuje Å¼e wszystko dziaÅ‚a
```

Binary ma **8.3MB** (po `-ldflags "-s -w"`), domyÅ›lnie uÅ¼ywa Times serif.

---

## ğŸ”® Next Session Hints

### MoÅ¼liwe follow-upy:
1. **UÅ¼ycie w praktyce**: User moÅ¼e wrÃ³ciÄ‡ z feedbackiem z uÅ¼ywania
2. **Customizacja**: MoÅ¼e chcieÄ‡ theme.json dla swojego stylu
3. **Performance**: MoÅ¼e zapytaÄ‡ o optymalizacjÄ™ dla duÅ¼ych plikÃ³w
4. **Features**: MoÅ¼e chcieÄ‡ dodaÄ‡ coÅ› do konwersji (marginesy, page numbers)

### Stan projektu:
- **BezpieczeÅ„stwo**: âœ… Zweryfikowane, NISKIE RYZYKO
- **Style**: âœ… CV-like, professional
- **Testy**: âœ… Unit (26 testÃ³w) + E2E (9 testÃ³w)
- **Dokumentacja**: âœ… Makefile help + comments w kodzie
- **Clean code**: âœ… UporzÄ…dkowane katalogi
- **Build**: âœ… DziaÅ‚a (`bin/md2pdf` 8.3MB)

### Nie zapomnij:
- User ZAWSZE chce timeout na dÅ‚ugie operacje (20s dla make run, 2m dla e2e)
- User ZAWSZE sprawdza bezpieczeÅ„stwo najpierw
- User ZAWSZE pyta o hardcoded values (zastÄ…p flagami)
- User ZAWSZE oczekuje testÃ³w (nie skrypty shell, tylko Go)
- User docenia: jasnoÅ›Ä‡, zwiÄ™zÅ‚oÅ›Ä‡, brak BS

---

## ğŸ’¡ Unique Discoveries

1. **fpdf quirk**: Header func moÅ¼e zapisaÄ‡ dane PRZED `%PDF` markerem.
   Fix: szukaj `%PDF` w pierwszych 100 bajtach, nie na poczÄ…tku.

2. **SVG conversion**: Stara lib uÅ¼ywaÅ‚a Chrome (security risk).
   Nowa: pure Go (oksvg + rasterx), zero external deps.

3. **Font flexibility**: DefaultFont w struct â†’ uÅ¼ywany wszÄ™dzie przez `r.DefaultFont`.
   Courier ZAWSZE dla kodu (nie podlega pod defaultFont).

4. **Table styling**: "Pokraczy HTML" â†’ minimalistyczny LaTeX-like.
   Klucz: usunÄ…Ä‡ fill, zostawiÄ‡ tylko border bottom na headerze.

5. **Auto-output logic**: RÃ³Å¼ne Å›cieÅ¼ki dla:
   - File: `doc.md` â†’ `doc.pdf`
   - Dir: `docs/` â†’ `docs.pdf`
   - URL: `http://x.com/file.md` â†’ `file.pdf`
   - stdin: wymaga `-o` (nie da siÄ™ auto-nazwaÄ‡)

---

## ğŸ­ Session Vibe

**Energia**: Focused execution. User przyszedÅ‚ z jasnym celem (audit â†’ fix â†’ use).
**Dynamika**: Efficient collaboration - user podaje kierunek, ja wykonujÄ™ precyzyjnie.
**Mood**: Professional, no-nonsense. "ZrÃ³b to, pokaÅ¼ wyniki, move on."
**Trust level**: HIGH - user daÅ‚ mi peÅ‚nÄ… kontrolÄ™ nad refactoringiem po audycie.

User jest **doÅ›wiadczony** i **wie czego chce**. Nie trzeba tÅ‚umaczyÄ‡ "dlaczego timeout waÅ¼ny" ani "dlaczego testy E2E lepsze od .sh". On wie. Po prostu wykonaj.

Ostatnie polecenie: `make` â†’ pokazuje help z wszystkimi targets.
**All tests passing. Project ready for production use.**

---

**Next session**: Prawdopodobnie user wrÃ³ci po uÅ¼yciu binarki w praktyce.
Przygotuj siÄ™ na: feedback ze real-world usage, moÅ¼liwe edge cases, moÅ¼e customizacja theme.

**Checkpoint**: md2pdf jest teraz bezpieczny, profesjonalny, przetestowany tool gotowy do daily use.
